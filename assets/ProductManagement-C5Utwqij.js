import{c as A,d as V,q as T,o as G,w as Y,g as Z,a as O,b as ee,u as te,e as le,r as oe,s as se,f as ae,h as ne,i as f,j as H,k as B,l as J,m as re,n as ie,p as de,t as b,v as e,x,y as o,z as w,A as k,B as ce,C as ue,D as pe,E as W,F as M,G as R,H as D,I as v,J as q}from"./index-B41RPdAA.js";import{M as me,_ as ge}from"./DeleteModal.vue_vue_type_script_setup_true_lang-C2_j-UUp.js";const fe=async n=>{try{const l=A(V,"products");let u=T(l,G("title"));n?.category&&(u=T(l,Y("category","==",n.category),G("title")));const a=await Z(u),r=[];a.forEach(U=>{r.push({id:U.id,...U.data()})});const i=parseInt(n?.page||"1"),h=10,y=(i-1)*h,d=y+h;return{data:{success:!0,products:r.slice(y,d),pagination:{total_pages:Math.ceil(r.length/h),current_page:i,has_pre:i>1,has_next:d<r.length,category:n?.category||""}}}}catch(l){throw new Error(l.message)}},be=async n=>{try{const l=A(V,"products");return{data:{success:!0,message:"已新增產品",product:{id:(await le(l,n)).id,...n}}}}catch(l){throw new Error(l.message)}},ve=async n=>{try{const{data:l,id:u}=n,a=O(V,"products",u);return await te(a,l),{data:{success:!0,message:"已更新產品",product:{id:u,...l}}}}catch(l){throw new Error(l.message)}},he=async n=>{try{const l=O(V,"products",n);return await ee(l),{data:{success:!0,message:"已刪除產品"}}}catch(l){throw new Error(l.message)}},ye=async n=>{try{const l=n.get("file");if(!l)throw new Error("沒有選擇檔案");const u=Date.now(),a=oe(se,`products/${u}_${l.name}`);return await ae(a,l),{data:{success:!0,message:"上傳成功",imageUrl:await ne(a)}}}catch(l){throw new Error(l.message)}},P=4;function _e(n){try{const l=new URL(n);return["http:","https:"].includes(l.protocol)}catch{return!1}}async function we(n){const l=new FormData;l.append("file-to-upload",n);try{return(await ye(l)).data.imageUrl}catch(u){throw alert("上傳圖片失敗"),u}}function Ue(n=[]){const l=f([...n]),u=f(""),a=f("未選擇檔案。"),r=f(null),i=f(!1);return{uploadedImages:l,imageUrlInput:u,fileNameDisplay:a,fileToUpload:r,isUploading:i,addImageUrl:()=>{const m=u.value.trim();if(m){if(l.value.length>=P){alert(`最多只能上傳 ${P} 張圖片`);return}if(!_e(m)){alert("請輸入有效的圖片 URL 格式 (需包含 http:// 或 https://)");return}l.value.push(m),u.value=""}},handleFileChange:m=>{const c=m.target,p=c.files?.[0];if(c.value="",!p){a.value="未選擇檔案。",r.value=null;return}if(!p.type.startsWith("image/")){alert("請選擇有效的圖片檔案！"),a.value="未選擇檔案。",r.value=null;return}if(l.value.length>=P){alert(`最多只能上傳 ${P} 張圖片！`),a.value="圖片數量已達上限，請先刪除圖片。",r.value=null;return}r.value=p,a.value=p.name},triggerUpload:async()=>{const m=r.value;if(!m){alert("請先選擇圖片檔案");return}if(!i.value)try{i.value=!0;const c=await we(m);l.value.push(c),r.value=null,a.value="未選擇檔案。",alert("圖片上傳成功！")}catch(c){console.error("圖片上傳失敗:",c),alert("圖片上傳失敗，請稍後再試。")}finally{i.value=!1}},deleteImage:m=>{l.value.splice(m,1)},resetImages:(m=[])=>{l.value=[...m].filter(Boolean),u.value="",a.value="未選擇檔案。",r.value=null,i.value=!1}}}const z=()=>({id:"",title:"",origin_price:0,price:0,category:"",unit:"",num:0,content:"",description:"",is_enabled:1,imageUrl:"",imagesUrl:[""]});function ke(){const n=f(z()),l=f("新增商品"),u=r=>{r?(n.value={...r},l.value="編輯商品"):a()},a=()=>{n.value=z(),l.value="新增商品"};return{form:n,formTitle:l,loadProduct:u,resetForm:a}}const xe={class:"modal-dialog modal-dialog-centered modal-lg"},$e={class:"modal-content rounded-lg"},Ce={class:"modal-header"},Ie={class:"modal-title",id:"addNewProductModalLabel"},Me={class:"modal-body"},Pe={class:"row"},De={class:"col-md-6"},Re={class:"mb-3"},Ve={class:"row"},Ee={class:"col-6 mb-3"},Fe={class:"col-6 mb-3"},Ne={class:"row"},Be={class:"col-6 mb-3"},Le={class:"col-6 mb-3"},Se={class:"mb-3"},je={class:"mb-3"},Te={class:"mb-3 d-flex align-items-center"},Ge={class:"form-check form-switch"},qe={class:"col-md-6"},ze={class:"mb-3"},Ae={class:"input-group mb-2"},Oe=["disabled"],He={class:"input-group mb-2"},Je={class:"file-name-display form-control rounded-lg"},We=["disabled"],Xe={key:0,class:"spinner-border spinner-border-sm me-1",role:"status","aria-hidden":"true"},Ke={class:"mb-3"},Qe={id:"imagesContainer",class:"d-flex flex-wrap gap-2"},Ye=["src"],Ze=["onClick"],et=["src"],tt={class:"modal-footer"},lt=["disabled"],ot=H({__name:"ProductModal",props:{product:{}},emits:["get-products"],setup(n,{expose:l,emit:u}){const a=u,r=B("modalRef");let i=null;J(()=>{r.value&&(i=new me(r.value))}),re(()=>{i&&i.dispose()});const h=()=>{i&&i.show()},y=()=>{i&&i.hide()},{form:d,formTitle:C,loadProduct:U}=ke(),{uploadedImages:m,imageUrlInput:c,fileToUpload:p,fileNameDisplay:g,isUploading:I,addImageUrl:L,triggerUpload:S,handleFileChange:j,deleteImage:X,resetImages:E}=Ue();ie(()=>n.product,$=>{$.id?(U($),E([$.imageUrl,...$.imagesUrl])):(U(null),E([]))},{immediate:!0,deep:!0});const K=de(()=>!!n.product.id),F=f(!1),Q=async()=>{const[$,...t]=m.value,{id:s,..._}=d.value;_.imageUrl=$,_.imagesUrl=t;const N={..._,imagesUrl:_.imagesUrl?_.imagesUrl:[""]};F.value=!0;try{K.value&&s?await ve({data:N,id:s}):await be(N),E([]),y()}catch{alert("新增/編輯產品失敗")}finally{F.value=!1,a("get-products")}};return l({openModal:h,closeModal:y}),($,t)=>(v(),b("div",{ref_key:"modalRef",ref:r,class:"modal fade",id:"addNewProductModal",tabindex:"-1","aria-labelledby":"addNewProductModalLabel","aria-hidden":"true"},[e("div",xe,[e("div",$e,[e("div",Ce,[e("h5",Ie,x(o(C)),1),e("button",{onClick:y,type:"button",class:"btn-close","data-bs-dismiss":"modal","aria-label":"Close"})]),e("div",Me,[e("div",Pe,[e("div",De,[e("form",null,[e("div",Re,[t[12]||(t[12]=e("label",{for:"productName",class:"form-label"},"商品名稱",-1)),w(e("input",{"onUpdate:modelValue":t[0]||(t[0]=s=>o(d).title=s),type:"text",class:"form-control rounded-lg",id:"productName"},null,512),[[k,o(d).title]])]),e("div",Ve,[e("div",Ee,[t[13]||(t[13]=e("label",{for:"productOriginalPrice",class:"form-label"},"原價",-1)),w(e("input",{"onUpdate:modelValue":t[1]||(t[1]=s=>o(d).origin_price=s),type:"number",class:"form-control rounded-lg",id:"productOriginalPrice"},null,512),[[k,o(d).origin_price]])]),e("div",Fe,[t[14]||(t[14]=e("label",{for:"productPrice",class:"form-label"},"售價",-1)),w(e("input",{"onUpdate:modelValue":t[2]||(t[2]=s=>o(d).price=s),type:"number",class:"form-control rounded-lg",id:"productPrice"},null,512),[[k,o(d).price]])])]),e("div",Ne,[e("div",Be,[t[15]||(t[15]=e("label",{for:"productCategory",class:"form-label"},"分類",-1)),w(e("input",{"onUpdate:modelValue":t[3]||(t[3]=s=>o(d).category=s),class:"form-control rounded-lg",id:"productCategory"},null,512),[[k,o(d).category]])]),e("div",Le,[t[16]||(t[16]=e("label",{for:"productUnit",class:"form-label"},"單位",-1)),w(e("input",{"onUpdate:modelValue":t[4]||(t[4]=s=>o(d).unit=s),class:"form-control rounded-lg",id:"productUnit"},null,512),[[k,o(d).unit]])])]),e("div",Se,[t[17]||(t[17]=e("label",{for:"productDescription",class:"form-label"},"商品內容",-1)),w(e("textarea",{"onUpdate:modelValue":t[5]||(t[5]=s=>o(d).content=s),class:"form-control rounded-lg",id:"productDescription",rows:"4"},null,512),[[k,o(d).content]])]),e("div",je,[t[18]||(t[18]=e("label",{for:"productDescription",class:"form-label"},"商品描述",-1)),w(e("textarea",{"onUpdate:modelValue":t[6]||(t[6]=s=>o(d).description=s),class:"form-control rounded-lg",id:"productDescription",rows:"4"},null,512),[[k,o(d).description]])]),e("div",Te,[t[19]||(t[19]=e("label",{class:"form-label me-3 mb-0"},"啟用",-1)),e("div",Ge,[w(e("input",{"onUpdate:modelValue":t[7]||(t[7]=s=>o(d).is_enabled=s),class:"form-check-input",type:"checkbox",id:"flexSwitchProductEnable","true-value":1,"false-value":0},null,512),[[ce,o(d).is_enabled]])])])])]),e("div",qe,[e("div",ze,[t[21]||(t[21]=e("label",{class:"form-label"},"上傳圖片 (最多 4 張)",-1)),e("div",Ae,[w(e("input",{type:"url",class:"form-control rounded-lg",placeholder:"輸入圖片連結","onUpdate:modelValue":t[8]||(t[8]=s=>ue(c)?c.value=s:null)},null,512),[[k,o(c)]]),e("button",{class:"btn btn-outline-secondary rounded-lg ms-2",type:"button",onClick:t[9]||(t[9]=(...s)=>o(L)&&o(L)(...s)),disabled:o(m).length>=4}," 新增連結 ",8,Oe)]),e("div",He,[t[20]||(t[20]=e("label",{class:"input-group-text rounded-lg",for:"imageInputFile"},"瀏覽...",-1)),e("input",{onChange:t[10]||(t[10]=(...s)=>o(j)&&o(j)(...s)),type:"file",class:"form-control d-none",id:"imageInputFile",accept:".jpg, .jpeg, .png"},null,32),e("div",Je,x(o(g)),1),e("button",{onClick:t[11]||(t[11]=(...s)=>o(S)&&o(S)(...s)),disabled:!o(p)||o(I)||o(m).length>=4,class:"btn btn-outline-secondary rounded-lg ms-2",type:"button"},[o(I)?(v(),b("span",Xe)):pe("",!0),W(" "+x(o(I)?"上傳中...":"上傳圖片"),1)],8,We)])]),e("div",Ke,[t[23]||(t[23]=e("div",{class:"d-flex justify-content-between align-items-center mb-2"},[e("label",{class:"form-label mb-0"},"已上傳圖片")],-1)),e("div",Qe,[(v(!0),b(M,null,R(o(m),(s,_)=>(v(),b("div",{key:_,class:D(["image-preview-thumbnail-container",{"main-image":_===0}])},[e("img",{src:s,class:"image-preview-thumbnail",alt:"商品圖片預覽"},null,8,Ye),e("button",{class:"btn btn-danger btn-sm delete-btn",onClick:N=>o(X)(_)},[...t[22]||(t[22]=[e("i",{class:"fas fa-times"},null,-1)])],8,Ze)],2))),128)),(v(!0),b(M,null,R(4-o(m).length,s=>(v(),b("div",{key:"placeholder-"+s,class:"image-preview-thumbnail-container"},[e("img",{src:`https://placehold.co/100x100/e9ecef/adb5bd?text=Image+${o(m).length+s}`,class:"image-preview-thumbnail"},null,8,et)]))),128))])])])])]),e("div",tt,[e("button",{onClick:y,type:"button",class:"btn btn-outline-secondary rounded-lg"}," 取消 "),e("button",{onClick:Q,disabled:F.value,type:"button",class:"btn btn-dark rounded-lg"}," 儲存 ",8,lt)])])])],512))}}),st={class:"d-flex justify-content-end align-items-center mb-4"},at={class:"card shadow-sm rounded-lg flex-grow-1"},nt={class:"card-body p-4"},rt={class:"table-responsive"},it={class:"table table-hover align-middle"},dt={class:"text-center"},ct={class:"form-check form-switch d-flex justify-content-center align-items-center"},ut=["checked"],pt={class:"text-nowrap"},mt=["onClick"],gt=["onClick"],ft={class:"d-flex justify-content-center mt-4"},bt={class:"pagination"},vt={class:"page-item"},ht=["disabled"],yt=["onClick","disabled"],_t={class:"page-item"},wt=["disabled"],$t=H({__name:"ProductManagement",setup(n){const l=B("productModalRef"),u=B("deleteModalRef"),a=f("1"),r=f([]),i=f({total_pages:0,current_page:0,has_pre:!1,has_next:!1,category:""}),h=async()=>{try{const c=await fe({page:a.value});r.value=c.data.products,i.value=c.data.pagination}catch{alert("取得產品列表失敗")}};J(()=>{h()});const d=f({id:"",title:"",origin_price:0,price:0,category:"",unit:"",num:0,content:"",description:"",is_enabled:1,imageUrl:"",imagesUrl:[""]}),C=(c=null)=>{c&&(d.value={...c,imagesUrl:c.imagesUrl?[...c.imagesUrl]:[""]}),l.value?.openModal()},U=c=>{u.value?.openModal(()=>m(c))},m=async c=>{try{await he(c)}catch{alert("刪除商品失敗")}finally{h()}};return(c,p)=>(v(),b(M,null,[e("div",st,[e("button",{onClick:p[0]||(p[0]=g=>C(null)),type:"button",class:"btn btn-dark rounded-lg px-4 py-2"},[...p[3]||(p[3]=[e("i",{class:"fas fa-plus me-2"},null,-1),W("新增商品 ",-1)])])]),e("div",at,[e("div",nt,[e("div",rt,[e("table",it,[p[4]||(p[4]=e("thead",null,[e("tr",null,[e("th",{scope:"col"},"分類"),e("th",{scope:"col"},"商品名稱"),e("th",{scope:"col"},"原價"),e("th",{scope:"col"},"售價"),e("th",{scope:"col",class:"text-center"},"啟用"),e("th",{scope:"col"})])],-1)),e("tbody",null,[(v(!0),b(M,null,R(r.value,g=>(v(),b("tr",{key:g.id},[e("td",null,x(g.category),1),e("td",null,x(g.title),1),e("td",null,x(g.origin_price),1),e("td",null,x(g.price),1),e("td",dt,[e("div",ct,[e("input",{readonly:"",class:"form-check-input",style:{"pointer-events":"none"},type:"checkbox",id:"flexSwitchCheckDefault1",checked:!!g.is_enabled},null,8,ut)])]),e("td",pt,[e("button",{onClick:I=>C(g),type:"button",class:"btn btn-sm btn-outline-dark rounded-lg me-2"}," 編輯 ",8,mt),e("button",{onClick:I=>U(g.id),type:"button",class:"btn btn-sm btn-outline-danger rounded-lg"}," 刪除 ",8,gt)])]))),128))])])]),e("nav",ft,[e("ul",bt,[e("li",vt,[e("button",{onClick:p[1]||(p[1]=g=>a.value=String(Number(a.value)-1)),disabled:!i.value?.has_pre,type:"button",class:D(["page-link",{disabled:!i.value?.has_pre}]),"aria-label":"Previous"},[...p[5]||(p[5]=[e("span",{"aria-hidden":"true"},"«",-1)])],10,ht)]),(v(!0),b(M,null,R(i.value?.total_pages,g=>(v(),b("li",{class:"page-item",key:g},[e("button",{onClick:I=>a.value=g.toString(),disabled:a.value===g.toString(),type:"button",class:D(["page-link",{active:a.value===g.toString()}])},x(g),11,yt)]))),128)),e("li",_t,[e("button",{onClick:p[2]||(p[2]=g=>a.value=String(Number(a.value)+1)),disabled:!i.value?.has_next,class:D(["page-link",{disabled:!i.value?.has_next}]),type:"button","aria-label":"Next"},[...p[6]||(p[6]=[e("span",{"aria-hidden":"true"},"»",-1)])],10,wt)])])])])]),q(ot,{ref_key:"productModalRef",ref:l,product:d.value,onGetProducts:h},null,8,["product"]),q(ge,{ref_key:"deleteModalRef",ref:u,title:"刪除商品",content:"確定要刪除該商品嗎？"},null,512)],64))}});export{$t as default};
