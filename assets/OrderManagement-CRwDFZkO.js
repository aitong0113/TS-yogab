import{g as O,h as w,q as S,m as L,j as E,n as N,p as T,d as C,A as k,o as R,B as z,c as u,a as e,l as x,t as a,J as y,K as M,k as c,r as h,e as D,L as f}from"./index-DelcrjFf.js";import{M as B,_ as q}from"./DeleteModal.vue_vue_type_script_setup_true_lang-DxwT4MCn.js";const A=async b=>{try{const d=O(w,"orders"),n=S(d,L("create_at","desc")),p=await E(n),s=[];p.forEach(v=>{const o=v.data();s.push({id:v.id,...o,products:o.products||{},num:o.num||0})});const m=parseInt(b?.page||"1"),r=10,_=(m-1)*r,t=_+r;return{data:{success:!0,orders:s.slice(_,t),pagination:{total_pages:Math.ceil(s.length/r),current_page:m,has_pre:m>1,has_next:t<s.length,category:""}}}}catch(d){throw new Error(d.message)}},I=async b=>{try{const d=N(w,"orders",b);return await T(d),{data:{success:!0,message:"已刪除訂單"}}}catch(d){throw new Error(d.message)}},P={class:"modal-dialog modal-dialog-centered modal-lg"},V={class:"modal-content rounded-lg"},W={class:"modal-body"},j={id:"modalOrderNumber"},F={id:"modalOrderDate"},G={id:"modalCustomerName"},J={id:"modalShippingAddress"},K={id:"modalCustomerEmail"},U={id:"modalCustomerPhone"},H={key:0},Q={class:"table table-bordered"},X={key:1,class:"text-muted"},Y={class:"h5 text-end"},Z={id:"modalOrderAmount",class:"text-danger"},ee=C({__name:"OrderDetailModal",props:{order:{}},setup(b,{expose:d}){const n=b,p=k("modalRef");let s=null;return R(()=>{p.value&&(s=new B(p.value))}),z(()=>{s&&s.dispose()}),d({openModal:()=>{s&&s.show()},closeModal:()=>{s&&s.hide()}}),(_,t)=>(c(),u("div",{ref_key:"modalRef",ref:p,class:"modal fade",id:"orderDetailModal",tabindex:"-1","aria-labelledby":"orderDetailModalLabel","aria-hidden":"true"},[e("div",P,[e("div",V,[t[14]||(t[14]=e("div",{class:"modal-header"},[e("h5",{class:"modal-title",id:"orderDetailModalLabel"},"訂單詳細資訊"),e("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal","aria-label":"Close"})],-1)),e("div",W,[e("p",null,[t[0]||(t[0]=e("strong",null,"訂單編號:",-1)),t[1]||(t[1]=x()),e("span",j,a(n.order.id),1)]),e("p",null,[t[2]||(t[2]=e("strong",null,"日期:",-1)),e("span",F,a(new Date(n.order.create_at*1e3).toLocaleDateString()),1)]),e("p",null,[t[3]||(t[3]=e("strong",null,"客戶名稱:",-1)),e("span",G,a(n.order.user.name),1)]),e("p",null,[t[4]||(t[4]=e("strong",null,"地址:",-1)),e("span",J,a(n.order.user.address),1)]),e("p",null,[t[5]||(t[5]=e("strong",null,"Email:",-1)),e("span",K,a(n.order.user.email),1)]),e("p",null,[t[6]||(t[6]=e("strong",null,"聯絡電話:",-1)),e("span",U,a(n.order.user.tel),1)]),t[11]||(t[11]=e("hr",null,null,-1)),t[12]||(t[12]=e("h6",null,"訂購商品",-1)),n.order.products&&Object.keys(n.order.products).length>0?(c(),u("div",H,[e("table",Q,[t[7]||(t[7]=e("thead",null,[e("tr",null,[e("th",null,"商品名稱"),e("th",null,"數量"),e("th",null,"小計")])],-1)),e("tbody",null,[(c(!0),u(y,null,M(n.order.products,g=>(c(),u("tr",{key:g.id},[e("td",null,a(g.product.title),1),e("td",null,a(g.qty),1),e("td",null,a(g.final_total.toLocaleString("zh-TW")),1)]))),128))])])])):(c(),u("div",X,[...t[8]||(t[8]=[e("p",null,"此訂單沒有商品明細資料",-1),e("p",{class:"small"},"註：前台建立的訂單可能沒有包含商品詳情，只記錄了訂單總金額。",-1)])])),t[13]||(t[13]=e("hr",null,null,-1)),e("p",Y,[t[9]||(t[9]=e("strong",null,"總金額:",-1)),e("span",Z,a(n.order.total.toLocaleString("zh-TW")),1),t[10]||(t[10]=x(" 元 ",-1))])]),t[15]||(t[15]=e("div",{class:"modal-footer"},[e("button",{type:"button",class:"btn btn-outline-secondary rounded-lg","data-bs-dismiss":"modal"}," 關閉 ")],-1))])])],512))}}),te={class:"card shadow-sm rounded-lg flex-grow-1"},se={class:"card-body p-4"},oe={class:"table-responsive"},le={class:"table table-hover align-middle"},ae={class:"order-number"},ne={class:"text-nowrap"},de=["onClick"],re=["onClick"],ie={class:"d-flex justify-content-center mt-4"},ue={class:"pagination"},ce={class:"page-item"},pe=["disabled"],me={class:"page-item"},ge=["onClick","disabled"],be={class:"page-item"},_e=["disabled"],fe=C({__name:"OrderManagement",setup(b){const d=k("orderDetailModalRef"),n=k("deleteModalRef"),p=h({create_at:0,id:"",is_paid:!1,total:0,message:"",products:{},user:{address:"",email:"",name:"",tel:""},num:0}),s=h("1"),m=h([]),r=h({total_pages:0,current_page:0,has_pre:!1,has_next:!1,category:""}),_=async()=>{try{const o=await A({page:s.value});console.log("API 回傳資料:",o),console.log("訂單列表:",o.data.orders),m.value=o.data.orders,r.value=o.data.pagination}catch(o){console.error("取得訂單列表失敗:",o),alert("取得訂單列表失敗: "+o)}};R(()=>{_()});const t=o=>{p.value=o,d.value?.openModal()},g=o=>{n.value?.openModal(()=>v(o))},v=async o=>{try{await I(o)}catch{alert("刪除訂單失敗")}finally{_()}};return(o,i)=>(c(),u(y,null,[e("div",te,[e("div",se,[e("div",oe,[e("table",le,[i[2]||(i[2]=e("thead",null,[e("tr",null,[e("th",{scope:"col"},"日期"),e("th",{scope:"col"},"訂單編號"),e("th",{scope:"col"},"品項"),e("th",{scope:"col"},"金額"),e("th",{scope:"col"},"訂單狀態"),e("th",{scope:"col"})])],-1)),e("tbody",null,[(c(!0),u(y,null,M(m.value,l=>(c(),u("tr",{key:l.id},[e("td",null,a(new Date(l.create_at*1e3).toLocaleDateString("zh-TW")),1),e("td",ae,a(l.id),1),e("td",null,a(l.products?Object.keys(l.products).length:0),1),e("td",null,"NT$ "+a(l.total),1),e("td",null,[e("span",{class:f(["badge",{"bg-success":l.is_paid,"bg-danger":!l.is_paid}])},a(l.is_paid?"已付款":"未付款"),3)]),e("td",ne,[e("button",{onClick:$=>t(l),type:"button",class:"btn btn-sm btn-outline-dark rounded-lg me-2"}," 查看 ",8,de),e("button",{onClick:$=>g(l.id),type:"button",class:"btn btn-sm btn-outline-danger rounded-lg"}," 刪除 ",8,re)])]))),128))])])]),e("nav",ie,[e("ul",ue,[e("li",ce,[e("button",{onClick:i[0]||(i[0]=l=>s.value=String(Number(s.value)-1)),disabled:!r.value?.has_pre,type:"button",class:f(["page-link",{disabled:!r.value?.has_pre}]),"aria-label":"Previous"},[...i[3]||(i[3]=[e("span",{"aria-hidden":"true"},"«",-1)])],10,pe)]),(c(!0),u(y,null,M(r.value?.total_pages,l=>(c(),u("li",me,[e("button",{onClick:$=>s.value=l.toString(),disabled:s.value===l.toString(),type:"button",class:f(["page-link",{active:s.value===l.toString()}])},a(l),11,ge)]))),256)),e("li",be,[e("button",{onClick:i[1]||(i[1]=l=>s.value=String(Number(s.value)+1)),disabled:!r.value?.has_next,class:f(["page-link",{disabled:!r.value?.has_next}]),type:"button","aria-label":"Next"},[...i[4]||(i[4]=[e("span",{"aria-hidden":"true"},"»",-1)])],10,_e)])])])])]),D(ee,{ref_key:"orderDetailModalRef",ref:d,order:p.value},null,8,["order"]),D(q,{ref_key:"deleteModalRef",ref:n,title:"刪除訂單",content:"確定要刪除該訂單嗎？"},null,512)],64))}});export{fe as default};
