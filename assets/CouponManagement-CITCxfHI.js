import{g as S,h as C,q as N,m as U,j,n as B,u as q,s as I,p as z,d as L,r as h,C as G,A as $,o as V,B as P,c as f,a as e,F as k,G as w,E as T,H as A,k as v,e as R,l as H,J as x,K as E,L as M,t as y}from"./index-DelcrjFf.js";import{M as J,_ as K}from"./DeleteModal.vue_vue_type_script_setup_true_lang-DxwT4MCn.js";const W=async i=>{try{const s=S(C,"coupons"),r=N(s,U("title")),t=await j(r),c=[];t.forEach(_=>{c.push({id:_.id,..._.data()})});const l=parseInt(i?.page||"1"),u=10,p=(l-1)*u,b=p+u;return{data:{success:!0,coupons:c.slice(p,b),pagination:{total_pages:Math.ceil(c.length/u),current_page:l,has_pre:l>1,has_next:b<c.length,category:""}}}}catch(s){throw new Error(s.message)}},Y=async i=>{try{const s=S(C,"coupons");return{data:{success:!0,message:"已新增優惠券",coupon:{id:(await I(s,i)).id,...i}}}}catch(s){throw new Error(s.message)}},O=async i=>{try{const{id:s,data:r}=i,t=B(C,"coupons",s);return await q(t,r),{data:{success:!0,message:"已更新優惠券",coupon:{id:s,...r}}}}catch(s){throw new Error(s.message)}},Q=async i=>{try{const s=B(C,"coupons",i);return await z(s),{data:{success:!0,message:"已刪除優惠券"}}}catch(s){throw new Error(s.message)}},F=i=>{const s=new Date(i*1e3),r=p=>p<10?"0"+p:p,t=s.getFullYear(),c=r(s.getMonth()+1),l=r(s.getDate());return`${t}-${c}-${l}`},X={class:"modal-dialog modal-dialog-centered modal-lg"},Z={class:"modal-content rounded-lg"},ee={class:"modal-body"},te={class:"mb-3"},oe={class:"mb-3"},se={class:"mb-3"},ae={class:"mb-3"},ne=["value"],le={class:"mb-3 d-flex align-items-center"},de={class:"form-check form-switch"},ie=["checked"],re={class:"modal-footer"},ce=["disabled"],ue=L({__name:"CouponModal",props:{coupon:{},isLoading:{type:Boolean}},setup(i,{expose:s}){const r={id:"",title:"",is_enabled:0,percent:0,due_date:Date.now()/1e3,code:""},t=h(r);G(()=>i.coupon,m=>{t.value=m});const c=$("modalRef");let l=null,u=null;V(()=>{c.value&&(l=new J(c.value))}),P(()=>{l&&l.dispose()});const p=m=>{l&&(l.show(),u=async o=>{try{await m(o),b()}catch{}})},b=()=>{l&&l.hide()},g=()=>{u&&u(t.value)},_=m=>{const o=m.target;t.value.due_date=new Date(o.value).getTime()/1e3};return s({openModal:p,closeModal:b}),(m,o)=>(v(),f("div",{ref_key:"modalRef",ref:c,class:"modal fade",id:"couponModal",tabindex:"-1","aria-labelledby":"couponModalLabel","aria-hidden":"true"},[e("div",X,[e("div",Z,[o[10]||(o[10]=e("div",{class:"modal-header"},[e("h5",{class:"modal-title",id:"couponModalLabel"},"新增優惠券"),e("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal","aria-label":"Close"})],-1)),e("div",ee,[e("form",null,[e("div",te,[o[4]||(o[4]=e("label",{for:"couponTitle",class:"form-label"},"優惠券標題",-1)),k(e("input",{"onUpdate:modelValue":o[0]||(o[0]=a=>t.value.title=a),type:"text",class:"form-control rounded-lg",id:"couponTitle",placeholder:"例如：新會員專屬折扣"},null,512),[[w,t.value.title]])]),e("div",oe,[o[5]||(o[5]=e("label",{for:"couponCode",class:"form-label"},"優惠碼",-1)),k(e("input",{"onUpdate:modelValue":o[1]||(o[1]=a=>t.value.code=a),type:"text",class:"form-control rounded-lg",id:"couponCode",placeholder:"例如：NEW2024"},null,512),[[w,t.value.code]])]),e("div",se,[o[6]||(o[6]=e("label",{for:"couponDiscount",class:"form-label"},"折扣",-1)),k(e("input",{"onUpdate:modelValue":o[2]||(o[2]=a=>t.value.percent=a),type:"number",max:"100",min:"0",class:"form-control rounded-lg",id:"couponDiscount",placeholder:"例如：90 代表 9 折"},null,512),[[w,t.value.percent,void 0,{number:!0}]])]),e("div",ae,[o[7]||(o[7]=e("label",{for:"couponEndDate",class:"form-label"},"截止日",-1)),e("input",{value:T(F)(t.value.due_date),onChange:_,type:"date",class:"form-control rounded-lg",id:"couponEndDate"},null,40,ne)]),e("div",le,[o[8]||(o[8]=e("label",{class:"form-label me-3 mb-0"},"啟用",-1)),e("div",de,[k(e("input",{"onUpdate:modelValue":o[3]||(o[3]=a=>t.value.is_enabled=a),class:"form-check-input",type:"checkbox",id:"flexSwitchCouponEnable",checked:!!t.value.is_enabled},null,8,ie),[[A,t.value.is_enabled]])])])])]),e("div",re,[o[9]||(o[9]=e("button",{type:"button",class:"btn btn-outline-secondary rounded-lg","data-bs-dismiss":"modal"}," 取消 ",-1)),e("button",{onClick:g,disabled:i.isLoading,type:"button",class:"btn btn-dark rounded-lg"}," 儲存 ",8,ce)])])])],512))}}),pe={class:"d-flex justify-content-end align-items-center pe-3 mb-4"},be={key:0,class:"text-center"},me={key:1,class:"card shadow-sm rounded-lg flex-grow-1"},fe={class:"card-body p-4"},ve={class:"table-responsive"},_e={class:"table table-hover align-middle"},ge={class:"text-center"},he={class:"form-check form-switch d-flex justify-content-center align-items-center"},ye=["checked"],ke={class:"text-nowrap"},Ce=["onClick"],we=["onClick"],xe={class:"d-flex justify-content-center mt-4"},Me={class:"pagination"},$e={class:"page-item"},De=["disabled"],Re=["onClick","disabled"],Ee={class:"page-item"},Se=["disabled"],Ve=L({__name:"CouponManagement",setup(i){const s={id:"",title:"",is_enabled:0,percent:0,due_date:Date.now()/1e3,code:""},r=h(s),t=h("1"),c=h([]),l=h({total_pages:0,current_page:0,has_pre:!1,has_next:!1,category:""}),u=async()=>{try{const a=await W({page:t.value});c.value=a.data.coupons,l.value=a.data.pagination}catch{alert("取得優惠券列表失敗")}};V(()=>{u()});const p=$("couponModalRef"),b=$("deleteModalRef"),g=h(!1),_=a=>{a?r.value={...a}:r.value=s,p.value?.openModal(async n=>{g.value=!0;try{a?await O({id:n.id,data:{...n,is_enabled:Number(n.is_enabled)}}):await Y({...n,is_enabled:Number(n.is_enabled)})}catch{alert("新增/編輯優惠券失敗")}finally{g.value=!1,u()}})},m=a=>{b.value?.openModal(()=>o(a))},o=async a=>{try{await Q(a)}catch{alert("刪除優惠券失敗")}finally{u()}};return(a,n)=>(v(),f(x,null,[e("div",pe,[e("button",{onClick:n[0]||(n[0]=d=>_()),class:"btn btn-dark rounded-lg px-4 py-2",type:"button"},[...n[3]||(n[3]=[e("i",{class:"fas fa-plus me-2"},null,-1),H("新增優惠券 ",-1)])])]),c.value?(v(),f("div",me,[e("div",fe,[e("div",ve,[e("table",_e,[n[4]||(n[4]=e("thead",null,[e("tr",null,[e("th",{scope:"col"},"優惠券標題"),e("th",{scope:"col"},"優惠碼"),e("th",{scope:"col"},"折扣"),e("th",{scope:"col"},"截止日"),e("th",{scope:"col",class:"text-center"},"啟用"),e("th",{scope:"col"})])],-1)),e("tbody",null,[(v(!0),f(x,null,E(c.value,d=>(v(),f("tr",{key:d.due_date},[e("td",null,y(d.title),1),e("td",null,y(d.code),1),e("td",null,y(d.percent)+" %",1),e("td",null,y(T(F)(d.due_date)),1),e("td",ge,[e("div",he,[e("input",{style:{"pointer-events":"none"},class:"form-check-input",type:"checkbox",readonly:"",checked:!!d.is_enabled},null,8,ye)])]),e("td",ke,[e("button",{onClick:D=>_(d),class:"btn btn-sm btn-outline-dark rounded-lg me-2",type:"button"}," 編輯 ",8,Ce),e("button",{onClick:D=>m(d.id),class:"btn btn-sm btn-outline-danger rounded-lg",type:"button"}," 刪除 ",8,we)])]))),128))])])]),e("nav",xe,[e("ul",Me,[e("li",$e,[e("button",{onClick:n[1]||(n[1]=d=>t.value=String(Number(t.value)-1)),disabled:!l.value?.has_pre,type:"button",class:M(["page-link",{disabled:!l.value?.has_pre}]),"aria-label":"Previous"},[...n[5]||(n[5]=[e("span",{"aria-hidden":"true"},"«",-1)])],10,De)]),(v(!0),f(x,null,E(l.value?.total_pages,d=>(v(),f("li",{class:"page-item",key:d},[e("button",{onClick:D=>t.value=d.toString(),disabled:t.value===d.toString(),type:"button",class:M(["page-link",{active:t.value===d.toString()}])},y(d),11,Re)]))),128)),e("li",Ee,[e("button",{onClick:n[2]||(n[2]=d=>t.value=String(Number(t.value)+1)),disabled:l.value?.has_next,class:M(["page-link",{disabled:l.value?.has_next}]),type:"button","aria-label":"Next"},[...n[6]||(n[6]=[e("span",{"aria-hidden":"true"},"»",-1)])],10,Se)])])])])])):(v(),f("p",be,"目前還沒有優惠券")),R(ue,{ref_key:"couponModalRef",ref:p,coupon:r.value,"is-loading":g.value},null,8,["coupon","is-loading"]),R(K,{ref_key:"deleteModalRef",ref:b,title:"刪除訂單",content:"確定要刪除該優惠券嗎？"},null,512)],64))}});export{Ve as default};
